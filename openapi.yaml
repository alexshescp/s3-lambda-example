openapi: 3.0.3
info:
  title: S3 Lambda Authorizer Example API
  version: 1.1.0
  description: |
    Sample API Gateway definition that uses the JWT-based Lambda authorizer defined in this repository.
    Import the document into API Gateway or use it with tools like [Stoplight](https://stoplight.io) to explore the API contract.
servers:
  - url: https://{apiId}.execute-api.{region}.amazonaws.com/{stage}
    description: API Gateway endpoint protected by the Lambda authorizer
    variables:
      apiId:
        default: yourApiId
        description: Identifier generated by Amazon API Gateway
      region:
        default: us-east-1
        description: AWS region where the API is deployed
      stage:
        default: dev
        description: API Gateway stage name
security:
  - bearerAuth: []
paths:
  /protected/files:
    get:
      summary: List files stored in the private S3 bucket
      description: |
        Returns the metadata of files available to the authenticated user. Access is denied when the Lambda
        authorizer rejects the incoming JWT.
      tags:
        - Files
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Successfully retrieved the metadata for the caller
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileListing'
        '401':
          description: Missing or invalid bearer token
        '403':
          description: Authenticated user lacks the required role
        '500':
          description: Unexpected error when processing the request
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri: arn:aws:apigateway:{region}:lambda:path/2015-03-31/functions/arn:aws:lambda:{region}:111122223333:function:listFilesLambda/invocations
        passthroughBehavior: when_no_templates
        payloadFormatVersion: '2.0'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: >-
        Provide a bearer token issued by your identity provider. The Lambda authorizer validates the token
        and checks the role claims specified in the `ALLOWED_ROLES` environment variable.
  schemas:
    FileListing:
      type: object
      description: Metadata returned when the caller is authorized to access the S3 bucket
      properties:
        files:
          type: array
          items:
            $ref: '#/components/schemas/FileMetadata'
      required:
        - files
    FileMetadata:
      type: object
      description: Metadata about a single file in the bucket
      properties:
        key:
          type: string
          description: Object key in S3
          example: invoices/2024-05.pdf
        lastModified:
          type: string
          format: date-time
          description: Timestamp when the object was last changed
          example: 2024-05-22T10:14:00Z
        size:
          type: integer
          format: int64
          description: Object size in bytes
          example: 189234
        etag:
          type: string
          description: ETag assigned by S3 when the object was uploaded
          example: '"9b2cf535f27731c974343645a3985328"'
    PolicyResponse:
      type: object
      description: IAM policy document produced by the Lambda authorizer when the request is allowed
      properties:
        principalId:
          type: string
          description: Authenticated user identifier
          example: user-1234
        policyDocument:
          type: object
          properties:
            Version:
              type: string
              example: '2012-10-17'
            Statement:
              type: array
              items:
                $ref: '#/components/schemas/PolicyStatement'
        context:
          $ref: '#/components/schemas/AuthorizerContext'
    PolicyStatement:
      type: object
      properties:
        Action:
          type: string
          example: execute-api:Invoke
        Effect:
          type: string
          enum:
            - Allow
            - Deny
        Resource:
          type: string
          example: arn:aws:execute-api:us-east-1:123456789012:abcdefghij/dev/GET/protected/files
    AuthorizerContext:
      type: object
      description: Key-value pairs attached to the request context when the authorizer succeeds
      properties:
        tokenIssuedAt:
          type: integer
          format: int64
          description: Token issuance time (Unix epoch seconds)
        tokenExpiresAt:
          type: integer
          format: int64
          description: Token expiration time (Unix epoch seconds)
        roles:
          type: string
          description: JSON array representing the roles extracted from the JWT claims
          example: '["admin", "editor"]'
        awsRegion:
          type: string
          description: Region configured for the protected API Gateway endpoint
          example: us-east-1
        awsAccountId:
          type: string
          description: Owning AWS account for the protected API Gateway endpoint
          example: '111122223333'
        s3Bucket:
          type: string
          description: Private S3 bucket exposed to callers when the request is authorized
          example: internal-documents
        s3Prefix:
          type: string
          description: Optional prefix that limits accessible objects within the S3 bucket
          example: protected/
